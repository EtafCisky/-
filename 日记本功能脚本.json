{
  "id": "diary-system-v1",
  "name": "日记本功能",
  "content": "// 获取当前脚本ID\nconst scriptId = getScriptId();\n\n// 设置快捷回复按钮\nreplaceScriptButtons(scriptId, [\n  { name: '日记本', visible: true },\n  { name: '写日记', visible: true }\n]);\n\n// 日记本名称常量\nconst DIARY_LOREBOOK_NAME = '日记本';\n\n// 日记格式的正则表达式 - 修正为支持多行内容\nconst DIARY_REGEX = /［日记标题：([^］]+)］[\\s\\S]*?［日记时间：([^］]+)］[\\s\\S]*?［日记内容：([\\s\\S]*?)］/g;\n\n// 页面大小（每页显示的日记数量）\nconst PAGE_SIZE = 8;\n\n// 检查是否为模板内容\nfunction isTemplateContent(title, time, content) {\n  // 检查是否包含模板变量语法 {{变量名}}\n  const templatePattern = /\\{\\{[^}]+\\}\\}/;\n  return templatePattern.test(title) || templatePattern.test(time) || templatePattern.test(content);\n}\n\n// 解析日记条目标题和时间\nfunction parseDiaryComment(comment) {\n  // 从 \"标题-时间\" 格式中解析出标题和时间\n  const lastDashIndex = comment.lastIndexOf('-');\n  if (lastDashIndex > 0) {\n    return {\n      title: comment.substring(0, lastDashIndex).trim(),\n      time: comment.substring(lastDashIndex + 1).trim()\n    };\n  }\n  return {\n    title: comment || '无标题日记',\n    time: '未知时间'\n  };\n}\n\n// 写日记功能\nasync function writeDiary() {\n  try {\n    // 确保日记本世界书存在\n    await ensureDiaryLorebook();\n\n    // 发送用户消息让AI写日记\n    const diaryPrompt = `以{{char}}的口吻写一则日记，日记格式为：\\n［日记标题：{{标题}}］\\n［日记时间：{{时间}}］\\n［日记内容：{{内容}}］`;\n    \n    await triggerSlash(`/send ${diaryPrompt} | /trigger`);\n    \n    toastr.success('已发送日记请求，等待AI回复...');\n    \n    // 开始监听新消息\n    startDiaryMessageListener();\n    \n  } catch (error) {\n    console.error('写日记失败:', error);\n    toastr.error('写日记功能出现错误');\n  }\n}\n\n// 确保日记本世界书存在\nasync function ensureDiaryLorebook() {\n  const lorebooks = getLorebooks();\n  if (!lorebooks.includes(DIARY_LOREBOOK_NAME)) {\n    const created = await createLorebook(DIARY_LOREBOOK_NAME);\n    if (!created) {\n      throw new Error('无法创建日记本世界书');\n    }\n  }\n  return DIARY_LOREBOOK_NAME;\n}\n\n// 消息监听器\nlet diaryMessageListener = null;\n\nfunction startDiaryMessageListener() {\n  if (diaryMessageListener) {\n    clearInterval(diaryMessageListener);\n  }\n  \n  const startTime = Date.now();\n  const timeout = 60000; // 60秒超时\n  let lastCheckedId = getLastMessageId();\n  \n  diaryMessageListener = setInterval(async () => {\n    try {\n      const currentLastId = getLastMessageId();\n      \n      // 检查是否有新消息\n      if (currentLastId > lastCheckedId) {\n        const newMessages = getChatMessages(`${lastCheckedId + 1}-${currentLastId}`);\n        \n        for (const message of newMessages) {\n          if (message.role === 'assistant') {\n            await processDiaryMessage(message.message);\n          }\n        }\n        \n        lastCheckedId = currentLastId;\n      }\n      \n      // 检查超时\n      if (Date.now() - startTime > timeout) {\n        clearInterval(diaryMessageListener);\n        diaryMessageListener = null;\n      }\n      \n    } catch (error) {\n      console.error('日记消息监听出错:', error);\n      clearInterval(diaryMessageListener);\n      diaryMessageListener = null;\n    }\n  }, 2000);\n}\n\n// 处理可能包含日记的消息\nasync function processDiaryMessage(messageText) {\n  // 重置正则表达式的lastIndex\n  DIARY_REGEX.lastIndex = 0;\n  const matches = [...messageText.matchAll(DIARY_REGEX)];\n  \n  if (matches.length === 0) return false;\n  \n  try {\n    // 确保日记本世界书存在\n    await ensureDiaryLorebook();\n    \n    // 获取当前角色名\n    const charName = substitudeMacros('{{char}}');\n    \n    let savedCount = 0;\n    \n    for (const match of matches) {\n      const title = match[1].trim();\n      const time = match[2].trim();\n      const content = match[3].trim();\n      \n      // 检查是否为模板内容，如果是则跳过\n      if (isTemplateContent(title, time, content)) {\n        console.log('跳过模板内容:', { title, time, content });\n        continue;\n      }\n      \n      // 创建世界书条目 - 新的存储格式\n      const entryData = {\n        keys: [charName], // 角色名作为关键字\n        content: content, // 条目内容\n        comment: `${title}-${time}`, // 标题-时间格式\n        enabled: true,\n        selective: false,\n        constant: false,\n        insertion_order: 100,\n        case_sensitive: false,\n        match_whole_words: false,\n        use_group_scoring: false,\n        position: 2, // after_char位置\n        role: 1 // system role\n      };\n      \n      const result = await createLorebookEntries(DIARY_LOREBOOK_NAME, [entryData]);\n      toastr.success(`已保存${charName}的日记: ${title}`);\n      savedCount++;\n    }\n    \n    // 只有保存了真实内容才停止监听\n    if (savedCount > 0 && diaryMessageListener) {\n      clearInterval(diaryMessageListener);\n      diaryMessageListener = null;\n    }\n    \n    return savedCount > 0;\n    \n  } catch (error) {\n    console.error('保存日记条目失败:', error);\n    toastr.error(`保存日记失败: ${error.message}`);\n    return false;\n  }\n}\n\n// 日记本界面功能\nasync function showDiaryBook() {\n  try {\n    // 检查是否存在日记本世界书\n    const lorebooks = getLorebooks();\n    if (!lorebooks.includes(DIARY_LOREBOOK_NAME)) {\n      toastr.info('还没有日记本世界书，请先写日记');\n      return;\n    }\n    \n    // 获取所有日记条目\n    const entries = await getLorebookEntries(DIARY_LOREBOOK_NAME);\n    \n    if (!entries || entries.length === 0) {\n      toastr.info('日记本还是空的，请先写日记');\n      return;\n    }\n    \n    // 按角色分类日记条目\n    const entriesByCharacter = {};\n    entries.forEach(entry => {\n      const charName = (entry.keys && entry.keys[0]) || '未知角色';\n      if (!entriesByCharacter[charName]) {\n        entriesByCharacter[charName] = [];\n      }\n      \n      const { title, time } = parseDiaryComment(entry.comment);\n      entriesByCharacter[charName].push({\n        uid: entry.uid,\n        title: title,\n        time: time,\n        content: entry.content || '内容为空',\n        charName: charName\n      });\n    });\n    \n    // 显示日记本界面\n    showDiaryInterface(entriesByCharacter);\n    \n  } catch (error) {\n    console.error('打开日记本失败:', error);\n    toastr.error('打开日记本功能出现错误');\n  }\n}\n\n// 显示日记本界面\nfunction showDiaryInterface(entriesByCharacter) {\n  // 清理现有样式和元素\n  $('style[data-id=\"diary-styles\"]').remove();\n  $('#diary-popup').remove();\n  \n  const totalEntries = Object.values(entriesByCharacter).reduce((sum, entries) => sum + entries.length, 0);\n  \n  // 添加丰富装饰的CSS样式\n  $('head').append(\n    $('<style>').attr('data-id', 'diary-styles').text(`\n    /* 日记本装饰样式 - 丰富版 */\n    \n    /* 关键帧动画定义 */\n    @keyframes floatingPatterns {\n      0%, 100% { transform: translateY(0px) rotate(0deg) scale(1); opacity: 0.6; }\n      25% { transform: translateY(-8px) rotate(2deg) scale(1.02); opacity: 0.8; }\n      50% { transform: translateY(-5px) rotate(-1deg) scale(0.98); opacity: 0.7; }\n      75% { transform: translateY(-12px) rotate(1deg) scale(1.01); opacity: 0.9; }\n    }\n    \n    @keyframes shimmerDecoration {\n      0% { opacity: 0.2; transform: translateX(-200%) rotate(0deg); }\n      50% { opacity: 0.8; transform: translateX(0%) rotate(180deg); }\n      100% { opacity: 0.2; transform: translateX(200%) rotate(360deg); }\n    }\n    \n    @keyframes paperRipple {\n      0%, 100% { transform: perspective(1200px) rotateX(2deg) rotateY(-1deg) scale(1); }\n      20% { transform: perspective(1200px) rotateX(0deg) rotateY(1deg) scale(1.01); }\n      40% { transform: perspective(1200px) rotateX(-1deg) rotateY(-0.5deg) scale(0.99); }\n      60% { transform: perspective(1200px) rotateX(1deg) rotateY(0.5deg) scale(1.005); }\n      80% { transform: perspective(1200px) rotateX(-0.5deg) rotateY(-1deg) scale(1.01); }\n    }\n    \n    @keyframes gentleGlow {\n      0%, 100% { box-shadow: 0 0 30px rgba(210, 180, 140, 0.4), inset 0 0 20px rgba(255, 255, 255, 0.1); }\n      50% { box-shadow: 0 0 50px rgba(222, 184, 135, 0.6), inset 0 0 30px rgba(255, 255, 255, 0.2); }\n    }\n    \n    @keyframes fadeInUp {\n      from { opacity: 0; transform: translateY(30px); }\n      to { opacity: 1; transform: translateY(0); }\n    }\n    \n    @keyframes sparkle {\n      0%, 100% { opacity: 0; transform: scale(0) rotate(0deg); }\n      50% { opacity: 1; transform: scale(1) rotate(180deg); }\n    }\n    \n    /* 主容器样式 */\n    .diary-popup-overlay {\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background: \n        radial-gradient(circle at 25% 25%, rgba(210, 180, 140, 0.15) 0%, transparent 40%),\n        radial-gradient(circle at 75% 75%, rgba(222, 184, 135, 0.12) 0%, transparent 40%),\n        radial-gradient(circle at 50% 10%, rgba(205, 133, 63, 0.08) 0%, transparent 30%),\n        linear-gradient(135deg, rgba(15, 10, 5, 0.94) 0%, rgba(25, 15, 10, 0.90) 100%);\n      z-index: 9999;\n      padding: 20px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      backdrop-filter: blur(12px);\n      animation: fadeInUp 0.8s ease-out;\n    }\n    \n    .diary-popup-overlay::before {\n      content: '';\n      position: absolute;\n      top: 0;\n      left: 0;\n      right: 0;\n      bottom: 0;\n      background-image: \n        radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.03) 1px, transparent 1px),\n        radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.02) 1px, transparent 1px),\n        radial-gradient(circle at 40% 60%, rgba(210, 180, 140, 0.05) 2px, transparent 2px);\n      background-size: 80px 80px, 60px 60px, 120px 120px;\n      animation: floatingPatterns 12s ease-in-out infinite;\n      pointer-events: none;\n    }\n    \n    .diary-popup-content {\n      background: \n        linear-gradient(145deg, #f9f6f1 0%, #f0ebe3 30%, #e8e0d6 70%, #e0d5c3 100%);\n      color: #2d1810;\n      padding: 0;\n      border-radius: 16px;\n      width: 95%;\n      max-width: 900px;\n      min-width: 480px;\n      text-align: center;\n      box-shadow: \n        0 30px 100px rgba(0, 0, 0, 0.5),\n        0 15px 60px rgba(210, 180, 140, 0.3),\n        0 8px 30px rgba(222, 184, 135, 0.25),\n        inset 0 2px 0 rgba(255, 255, 255, 0.7),\n        inset 0 -2px 0 rgba(210, 180, 140, 0.2);\n      border: 4px solid #c4a87c;\n      overflow: hidden;\n      position: relative;\n      margin: auto;\n      max-height: 85vh;\n      transform: perspective(1200px) rotateX(2deg) rotateY(-1deg);\n      transition: all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);\n      animation: paperRipple 8s ease-in-out infinite;\n    }\n    \n    .diary-popup-content:hover {\n      transform: perspective(1200px) rotateX(0deg) rotateY(0deg) scale(1.02);\n      animation-play-state: paused;\n    }\n    \n    .diary-popup-content::before {\n      content: '';\n      position: absolute;\n      top: 0;\n      left: 0;\n      right: 0;\n      bottom: 0;\n      background: \n        repeating-linear-gradient(\n          45deg,\n          transparent,\n          transparent 25px,\n          rgba(210, 180, 140, 0.03) 25px,\n          rgba(210, 180, 140, 0.03) 50px\n        ),\n        radial-gradient(circle at 30% 30%, rgba(205, 133, 63, 0.08) 0%, transparent 60%),\n        radial-gradient(circle at 70% 70%, rgba(222, 184, 135, 0.06) 0%, transparent 60%);\n      pointer-events: none;\n    }\n    \n    .diary-popup-content::after {\n      content: '';\n      position: absolute;\n      left: 25px;\n      top: 0;\n      bottom: 0;\n      width: 3px;\n      background: \n        linear-gradient(to bottom, \n          transparent 0%, \n          rgba(210, 180, 140, 0.4) 15%, \n          rgba(210, 180, 140, 0.2) 85%, \n          transparent 100%\n        );\n      box-shadow: \n        2px 0 0 rgba(205, 133, 63, 0.3),\n        5px 0 0 rgba(210, 180, 140, 0.15),\n        1px 0 10px rgba(210, 180, 140, 0.2);\n    }\n    \n    /* 标题栏样式 */\n    .diary-header {\n      background: \n        linear-gradient(135deg, \n          #7a4d2a 0%, \n          #6b3511 25%, \n          #7a4d2a 50%,\n          #6b3511 75%,\n          #562a17 100%\n        );\n      padding: 25px 30px;\n      display: flex;\n      align-items: center;\n      justify-content: space-between;\n      border-bottom: 4px solid #bc9a6a;\n      position: relative;\n      box-shadow: \n        0 4px 15px rgba(0, 0, 0, 0.4),\n        inset 0 2px 0 rgba(255, 255, 255, 0.3),\n        inset 0 -1px 0 rgba(0, 0, 0, 0.2);\n      overflow: hidden;\n    }\n    \n    .diary-header::before {\n      content: '';\n      position: absolute;\n      top: 50%;\n      left: 0;\n      right: 0;\n      height: 3px;\n      background: linear-gradient(90deg, \n        transparent 0%, \n        rgba(205, 133, 63, 0.8) 25%, \n        rgba(255, 215, 0, 0.6) 50%, \n        rgba(205, 133, 63, 0.8) 75%, \n        transparent 100%\n      );\n      animation: shimmerDecoration 4s ease-in-out infinite;\n      transform: translateY(-50%);\n    }\n    \n    .diary-header::after {\n      display: none;\n    }\n    \n    .diary-title {\n      color: #f9f6f1;\n      font-size: 22px;\n      font-weight: 800;\n      margin: 0;\n      text-shadow: \n        3px 3px 6px rgba(0, 0, 0, 0.6),\n        0 0 20px rgba(255, 215, 0, 0.3),\n        0 0 40px rgba(255, 215, 0, 0.1);\n      letter-spacing: 1px;\n      font-family: 'Georgia', 'Times New Roman', serif;\n      position: relative;\n    }\n    \n    .diary-close-btn {\n      background: \n        radial-gradient(circle at center, rgba(245, 241, 234, 0.2) 0%, rgba(211, 47, 47, 0.1) 70%);\n      border: 3px solid rgba(245, 241, 234, 0.4);\n      color: #f9f6f1;\n      cursor: pointer;\n      border-radius: 50%;\n      width: 42px;\n      height: 42px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      font-size: 20px;\n      font-weight: bold;\n      transition: all 0.4s ease;\n      backdrop-filter: blur(10px);\n      position: relative;\n      overflow: hidden;\n    }\n    \n    .diary-close-btn::before {\n      content: '';\n      position: absolute;\n      top: 0;\n      left: 0;\n      right: 0;\n      bottom: 0;\n      background: radial-gradient(circle at center, transparent 0%, rgba(211, 47, 47, 0.3) 100%);\n      transform: scale(0);\n      transition: transform 0.3s ease;\n    }\n    \n    .diary-close-btn:hover {\n      background: rgba(211, 47, 47, 0.9);\n      border-color: #d32f2f;\n      transform: scale(1.15) rotate(90deg);\n      box-shadow: \n        0 8px 25px rgba(211, 47, 47, 0.5),\n        inset 0 2px 10px rgba(255, 255, 255, 0.2);\n    }\n    \n    .diary-close-btn:hover::before {\n      transform: scale(1);\n    }\n    \n    /* 内容区域样式 */\n    .diary-content {\n      padding: 35px;\n      overflow-y: auto;\n      max-height: 70vh;\n      background: \n        radial-gradient(circle at 95% 5%, rgba(245, 241, 234, 0.4) 0%, transparent 50%),\n        radial-gradient(circle at 5% 95%, rgba(235, 228, 214, 0.3) 0%, transparent 50%);\n      position: relative;\n    }\n    \n    /* 封面设计 - 简洁文字+装饰风格 */\n    .diary-cover {\n      text-align: center;\n      padding: 56px 36px 36px;\n      background: \n        radial-gradient(1200px 600px at 50% -200px, rgba(255, 215, 180, 0.18) 0%, transparent 60%), \n        linear-gradient(135deg, #f6ecd9 0%, #efe1c8 50%, #e6d6b8 100%); \n      margin: 36px 18px;\n      border: 2px solid #caa574;\n      border-radius: 18px;\n      position: relative;\n      transition: transform 0.25s ease, box-shadow 0.25s ease;\n      box-shadow: \n        0 10px 30px rgba(0, 0, 0, 0.22), \n        inset 0 2px 0 rgba(255, 255, 255, 0.65);\n    }\n    \n    .diary-cover::before {\n      content: '';\n      position: absolute;\n      inset: 14px;\n      border: 1px solid rgba(196, 168, 124, 0.5);\n      border-radius: 14px;\n      box-shadow: inset 0 0 0 8px rgba(255, 255, 255, 0.25);\n      background: \n        repeating-linear-gradient(0deg, transparent, transparent 28px, rgba(210, 180, 140, 0.10) 29px, rgba(210, 180, 140, 0.10) 30px), \n        radial-gradient(600px 300px at 20% 0%, rgba(222, 184, 135, 0.15) 0%, transparent 60%), \n        radial-gradient(600px 300px at 80% 100%, rgba(210, 180, 140, 0.12) 0%, transparent 60%);\n      pointer-events: none;\n    }\n    \n    .diary-cover::after {\n      content: '';\n      position: absolute;\n      top: 0;\n      left: 28px;\n      bottom: 0;\n      width: 4px;\n      background: linear-gradient(to bottom, rgba(205, 133, 63, 0.35), rgba(210, 180, 140, 0.55), rgba(205, 133, 63, 0.35));\n      box-shadow: \n        2px 0 0 rgba(255, 255, 255, 0.5), \n        -2px 0 0 rgba(120, 80, 40, 0.15);\n      pointer-events: none;\n    }\n    \n    .diary-cover:hover {\n      transform: translateY(-6px) scale(1.02);\n      box-shadow: \n        0 20px 48px rgba(0, 0, 0, 0.35), \n        inset 0 3px 0 rgba(255, 255, 255, 0.5);\n    }\n    \n    .diary-cover-inner {\n      position: relative;\n      padding: 6px 8px;\n    }\n    \n    .diary-cover-title {\n      font-size: 36px;\n      font-weight: 900;\n      color: #3e2723;\n      margin-bottom: 15px;\n      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);\n      letter-spacing: 1px;\n      font-family: 'Georgia', 'Times New Roman', serif;\n      position: relative;\n      z-index: 2;\n    }\n    \n    .diary-cover-subtitle {\n      font-size: 16px;\n      color: #5d4037;\n      font-style: italic;\n      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.15);\n      position: relative;\n      z-index: 2;\n      font-family: 'Georgia', 'Times New Roman', serif;\n      line-height: 1.4;\n      margin-bottom: 25px;\n    }\n    \n    .diary-cover-button {\n      background: \n        linear-gradient(135deg, #d2b48c 0%, #deb887 50%, #d2b48c 100%);\n      color: #3e2723;\n      border: 2px solid #bc9a6a;\n      padding: 12px 24px;\n      border-radius: 25px;\n      cursor: pointer;\n      font-size: 14px;\n      font-weight: 700;\n      transition: all 0.3s ease;\n      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);\n      box-shadow: \n        0 4px 12px rgba(0, 0, 0, 0.2),\n        inset 0 1px 0 rgba(255, 255, 255, 0.3);\n      font-family: 'Georgia', 'Times New Roman', serif;\n      position: relative;\n      z-index: 2;\n      display: inline-block;\n    }\n    \n    .diary-cover-button:hover {\n      background: \n        linear-gradient(135deg, #bc9a6a 0%, #d2b48c 50%, #bc9a6a 100%);\n      transform: translateY(-2px) scale(1.05);\n      box-shadow: \n        0 8px 20px rgba(0, 0, 0, 0.3),\n        inset 0 2px 0 rgba(255, 255, 255, 0.4);\n      color: #2e1a14;\n    }\n    \n    /* 角色目录设计 - 羊皮纸风格 */\n    .diary-character-list {\n      background: \n        linear-gradient(135deg, #f7f4e8 0%, #f0ebe3 50%, #e8e0d6 100%);\n      padding: 40px 35px;\n      border: 3px solid #c4a87c;\n      margin: 20px;\n      border-radius: 16px;\n      display: none;\n      position: relative;\n      box-shadow: \n        inset 0 3px 8px rgba(0, 0, 0, 0.15),\n        inset 0 -2px 0 rgba(255, 255, 255, 0.6),\n        0 10px 30px rgba(0, 0, 0, 0.2);\n      overflow: hidden;\n    }\n    \n    .diary-character-list::before {\n      content: '';\n      position: absolute;\n      top: 20px;\n      left: 20px;\n      right: 20px;\n      bottom: 20px;\n      border: 2px dashed rgba(210, 180, 140, 0.3);\n      border-radius: 12px;\n      pointer-events: none;\n    }\n    \n    .diary-character-list::after {\n      content: '';\n      position: absolute;\n      top: 0;\n      left: 0;\n      right: 0;\n      bottom: 0;\n      background: \n        repeating-linear-gradient(\n          0deg,\n          transparent,\n          transparent 28px,\n          rgba(210, 180, 140, 0.06) 28px,\n          rgba(210, 180, 140, 0.06) 30px\n        );\n      pointer-events: none;\n    }\n    \n    .diary-character-list-title {\n      font-size: 24px;\n      font-weight: 800;\n      color: #2d1810;\n      margin-bottom: 30px;\n      text-align: center;\n      border-bottom: 3px solid #c4a87c;\n      padding-bottom: 20px;\n      font-family: 'Georgia', 'Times New Roman', serif;\n      position: relative;\n      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);\n    }\n    \n    .diary-character-list-title::before,\n    .diary-character-list-title::after {\n      content: '❀';\n      position: absolute;\n      color: #deb887;\n      font-size: 20px;\n      top: 50%;\n      transform: translateY(-50%);\n      animation: sparkle 4s ease-in-out infinite;\n    }\n    \n    .diary-character-list-title::before {\n      left: 25px;\n    }\n    \n    .diary-character-list-title::after {\n      right: 25px;\n      animation-delay: 2s;\n    }\n    \n    .diary-characters-grid {\n      display: grid;\n      grid-template-columns: repeat(2, 1fr);\n      gap: 25px;\n      margin-bottom: 25px;\n    }\n    \n    .diary-character-item {\n      background: \n        linear-gradient(135deg, #ebe4d6 0%, #e0d5c3 50%, #d5cbb8 100%);\n      border: 3px solid #c4a87c;\n      border-radius: 16px;\n      padding: 30px 25px;\n      cursor: pointer;\n      transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);\n      text-align: center;\n      position: relative;\n      overflow: hidden;\n      box-shadow: \n        0 8px 20px rgba(0, 0, 0, 0.15),\n        inset 0 2px 0 rgba(255, 255, 255, 0.6),\n        inset 0 -1px 0 rgba(210, 180, 140, 0.2);\n    }\n    \n    .diary-character-item::before {\n      content: '';\n      position: absolute;\n      top: 10px;\n      left: 10px;\n      right: 10px;\n      bottom: 10px;\n      border: 1px solid rgba(210, 180, 140, 0.2);\n      border-radius: 12px;\n      background: \n        radial-gradient(circle at 50% 50%, rgba(210, 180, 140, 0.08) 0%, transparent 80%);\n      transform: scale(0.95);\n      transition: all 0.4s ease;\n      pointer-events: none;\n    }\n    \n    .diary-character-item::after {\n      content: '✦';\n      position: absolute;\n      top: 15px;\n      right: 15px;\n      color: rgba(222, 184, 135, 0.5);\n      font-size: 16px;\n      transform: rotate(0deg);\n      transition: all 0.4s ease;\n    }\n    \n    .diary-character-item:hover {\n      background: \n        linear-gradient(135deg, #f2ebdd 0%, #e8ddd0 50%, #ddd2c0 100%);\n      transform: translateY(-8px) scale(1.05) rotateX(5deg);\n      box-shadow: \n        0 20px 40px rgba(0, 0, 0, 0.25),\n        inset 0 3px 0 rgba(255, 255, 255, 0.8),\n        0 0 0 4px rgba(210, 180, 140, 0.15),\n        0 0 30px rgba(255, 215, 0, 0.2);\n      border-color: #deb887;\n    }\n    \n    .diary-character-item:hover::before {\n      transform: scale(1);\n      background: \n        radial-gradient(circle at 50% 50%, rgba(210, 180, 140, 0.12) 0%, transparent 80%);\n    }\n    \n    .diary-character-item:hover::after {\n      transform: rotate(180deg) scale(1.2);\n      color: rgba(255, 215, 0, 0.8);\n    }\n    \n    .diary-character-name {\n      font-size: 20px;\n      font-weight: 700;\n      color: #2d1810;\n      margin-bottom: 12px;\n      font-family: 'Georgia', 'Times New Roman', serif;\n      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);\n    }\n    \n    .diary-character-count {\n      font-size: 15px;\n      color: #d2b48c;\n      font-style: italic;\n      font-weight: 500;\n    }\n    \n    /* 日记目录设计 - 古典书页风格 */\n    .diary-index {\n      background: \n        linear-gradient(135deg, #f7f4e8 0%, #f0ebe3 30%, #e8e0d6 70%, #e0d5c3 100%);\n      padding: 40px 35px;\n      border: 3px solid #c4a87c;\n      margin: 20px;\n      border-radius: 16px;\n      display: none;\n      position: relative;\n      box-shadow: \n        inset 0 3px 8px rgba(0, 0, 0, 0.15),\n        inset 0 -2px 0 rgba(255, 255, 255, 0.6),\n        0 10px 30px rgba(0, 0, 0, 0.2);\n      overflow: hidden;\n    }\n    \n    .diary-index::before {\n      content: '';\n      position: absolute;\n      top: 0;\n      left: 0;\n      right: 0;\n      bottom: 0;\n      background: \n        repeating-linear-gradient(\n          0deg,\n          transparent,\n          transparent 30px,\n          rgba(210, 180, 140, 0.04) 30px,\n          rgba(210, 180, 140, 0.04) 32px\n        );\n      pointer-events: none;\n    }\n    \n    .diary-index-header {\n      margin-bottom: 30px;\n      display: flex;\n      align-items: center;\n      justify-content: space-between;\n      border-bottom: 3px solid #c4a87c;\n      padding-bottom: 20px;\n      position: relative;\n    }\n    \n    .diary-index-header::before {\n      display: none;\n    }\n    \n    .diary-back-to-characters-btn {\n      background: \n        linear-gradient(135deg, #d2b48c 0%, #deb887 50%, #d2b48c 100%);\n      color: #f9f6f1;\n      border: 3px solid #bc9a6a;\n      padding: 12px 22px;\n      border-radius: 25px;\n      cursor: pointer;\n      font-size: 14px;\n      font-weight: 700;\n      transition: all 0.4s ease;\n      flex-shrink: 0;\n      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.4);\n      box-shadow: \n        0 6px 12px rgba(0, 0, 0, 0.25),\n        inset 0 2px 0 rgba(255, 255, 255, 0.3);\n      position: relative;\n      overflow: hidden;\n    }\n    \n    .diary-back-to-characters-btn::before {\n      content: '';\n      position: absolute;\n      top: 0;\n      left: -100%;\n      width: 100%;\n      height: 100%;\n      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);\n      transition: left 0.5s ease;\n    }\n    \n    .diary-back-to-characters-btn:hover {\n      background: \n        linear-gradient(135deg, #bc9a6a 0%, #d2b48c 50%, #bc9a6a 100%);\n      transform: translateY(-3px) scale(1.08);\n      box-shadow: \n        0 10px 20px rgba(0, 0, 0, 0.35),\n        inset 0 3px 0 rgba(255, 255, 255, 0.4),\n        0 0 20px rgba(255, 215, 0, 0.3);\n    }\n    \n    .diary-back-to-characters-btn:hover::before {\n      left: 100%;\n    }\n    \n    .diary-index-title {\n      font-size: 22px;\n      font-weight: 800;\n      color: #2d1810;\n      text-align: center;\n      flex-grow: 1;\n      margin: 0 20px;\n      font-family: 'Georgia', 'Times New Roman', serif;\n      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);\n    }\n    \n    .diary-entries-grid {\n      display: grid;\n      grid-template-columns: repeat(2, 1fr);\n      gap: 20px;\n      margin-bottom: 30px;\n    }\n    \n    .diary-entry-item {\n      background: \n        linear-gradient(135deg, #ebe4d6 0%, #e0d5c3 100%);\n      border: 2px solid #c4a87c;\n      border-radius: 12px;\n      padding: 20px 18px;\n      cursor: pointer;\n      transition: all 0.4s ease;\n      text-align: left;\n      position: relative;\n      overflow: hidden;\n      box-shadow: \n        0 4px 12px rgba(0, 0, 0, 0.12),\n        inset 0 1px 0 rgba(255, 255, 255, 0.6);\n    }\n    \n    .diary-entry-item::before {\n      content: '';\n      position: absolute;\n      left: 0;\n      top: 0;\n      bottom: 0;\n      width: 5px;\n      background: linear-gradient(to bottom, #deb887, #d2b48c);\n      border-radius: 12px 0 0 12px;\n      transform: scaleY(0);\n      transition: transform 0.4s ease;\n    }\n    \n    .diary-entry-item::after {\n      content: '✧';\n      position: absolute;\n      top: 15px;\n      right: 15px;\n      color: rgba(222, 184, 135, 0.4);\n      font-size: 14px;\n      transform: scale(0) rotate(0deg);\n      transition: all 0.4s ease;\n    }\n    \n    .diary-entry-item:hover {\n      background: \n        linear-gradient(135deg, #f2ebdd 0%, #e8ddd0 100%);\n      transform: translateY(-5px) scale(1.03);\n      box-shadow: \n        0 12px 30px rgba(0, 0, 0, 0.2),\n        inset 0 2px 0 rgba(255, 255, 255, 0.8),\n        0 0 0 3px rgba(210, 180, 140, 0.1),\n        0 0 20px rgba(255, 215, 0, 0.15);\n      border-color: #deb887;\n    }\n    \n    .diary-entry-item:hover::before {\n      transform: scaleY(1);\n    }\n    \n    .diary-entry-item:hover::after {\n      transform: scale(1) rotate(180deg);\n      color: rgba(255, 215, 0, 0.8);\n    }\n    \n    .diary-entry-title {\n      font-size: 16px;\n      font-weight: 700;\n      color: #2d1810;\n      margin-bottom: 10px;\n      font-family: 'Georgia', 'Times New Roman', serif;\n      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.05);\n      /* 修复文本溢出问题 */\n      width: calc(100% - 30px);\n      overflow: hidden;\n      text-overflow: ellipsis;\n      white-space: nowrap;\n      display: block;\n    }\n    \n    .diary-entry-time {\n      font-size: 13px;\n      color: #d2b48c;\n      font-style: italic;\n      font-weight: 500;\n    }\n    \n    /* 分页控件样式 */\n    .diary-pagination {\n      display: flex;\n      justify-content: center;\n      align-items: center;\n      gap: 15px;\n      margin-top: 30px;\n      padding-top: 25px;\n      border-top: 2px solid #c4a87c;\n      position: relative;\n    }\n    \n    .diary-pagination::before {\n      display: none;\n      position: absolute;\n      top: -10px;\n      left: 50%;\n      transform: translateX(-50%);\n      background: #f7f4e8;\n      color: #deb887;\n      font-size: 14px;\n      padding: 5px 12px;\n      border-radius: 8px;\n      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);\n    }\n    \n    .diary-page-btn {\n      background: \n        linear-gradient(135deg, #d2b48c 0%, #deb887 50%, #d2b48c 100%);\n      color: #f9f6f1;\n      border: 2px solid #bc9a6a;\n      padding: 10px 18px;\n      border-radius: 20px;\n      cursor: pointer;\n      font-size: 13px;\n      font-weight: 600;\n      transition: all 0.3s ease;\n      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.4);\n      box-shadow: \n        0 4px 8px rgba(0, 0, 0, 0.25),\n        inset 0 1px 0 rgba(255, 255, 255, 0.2);\n    }\n    \n    .diary-page-btn:hover {\n      background: \n        linear-gradient(135deg, #bc9a6a 0%, #d2b48c 50%, #bc9a6a 100%);\n      transform: translateY(-2px) scale(1.08);\n      box-shadow: \n        0 8px 16px rgba(0, 0, 0, 0.35),\n        inset 0 2px 0 rgba(255, 255, 255, 0.3);\n    }\n    \n    .diary-page-btn:disabled {\n      background: #c4a87c;\n      border-color: #a0916f;\n      color: rgba(245, 241, 234, 0.6);\n      cursor: not-allowed;\n      transform: none;\n      box-shadow: none;\n    }\n    \n    .diary-page-info {\n      font-size: 14px;\n      color: #d2b48c;\n      font-weight: 700;\n      font-family: 'Georgia', 'Times New Roman', serif;\n      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);\n    }\n    \n    /* 日记详情页面设计 - 手写纸张风格 */\n    .diary-detail {\n      background: \n        linear-gradient(135deg, #f9f6f1 0%, #f0ebe3 30%, #e8e0d6 70%, #e0d5c3 100%);\n      padding: 40px 50px;\n      border: 3px solid #c4a87c;\n      margin: 15px;\n      border-radius: 16px;\n      display: none;\n      text-align: left;\n      position: relative;\n      box-shadow: \n        inset 0 3px 8px rgba(0, 0, 0, 0.15),\n        inset 0 -2px 0 rgba(255, 255, 255, 0.6),\n        0 10px 30px rgba(0, 0, 0, 0.2);\n      overflow: hidden;\n    }\n    \n    .diary-detail::before {\n      content: '';\n      position: absolute;\n      top: 0;\n      left: 0;\n      right: 0;\n      bottom: 0;\n      background: \n        repeating-linear-gradient(\n          0deg,\n          transparent,\n          transparent 26px,\n          rgba(210, 180, 140, 0.08) 26px,\n          rgba(210, 180, 140, 0.08) 28px\n        );\n      pointer-events: none;\n    }\n    \n    .diary-detail::after {\n      content: '';\n      position: absolute;\n      left: 50px;\n      top: 0;\n      bottom: 0;\n      width: 2px;\n      background: rgba(210, 180, 140, 0.25);\n      box-shadow: \n        1px 0 0 rgba(255, 255, 255, 0.3),\n        -1px 0 0 rgba(210, 180, 140, 0.1);\n    }\n    \n    .diary-detail-title {\n      font-size: 26px;\n      font-weight: 800;\n      color: #2d1810;\n      margin-bottom: 20px;\n      text-align: center;\n      border-bottom: 3px solid #c4a87c;\n      padding-bottom: 20px;\n      font-family: 'Georgia', 'Times New Roman', serif;\n      position: relative;\n      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);\n    }\n    \n    .diary-detail-title::before,\n    .diary-detail-title::after {\n      content: '✿';\n      position: absolute;\n      color: #deb887;\n      font-size: 18px;\n      top: 50%;\n      transform: translateY(-50%);\n      animation: sparkle 5s ease-in-out infinite;\n    }\n    \n    .diary-detail-title::before {\n      left: 20px;\n    }\n    \n    .diary-detail-title::after {\n      right: 20px;\n      animation-delay: 2.5s;\n    }\n    \n    .diary-detail-time {\n      font-size: 16px;\n      color: #d2b48c;\n      text-align: center;\n      margin-bottom: 30px;\n      font-style: italic;\n      font-weight: 600;\n      font-family: 'Georgia', 'Times New Roman', serif;\n      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.05);\n    }\n    \n    .diary-detail-content {\n      font-size: 16px;\n      line-height: 1.6;\n      color: #2d1810;\n      background: \n        linear-gradient(135deg, #ebe4d6 0%, #e0d5c3 100%);\n      padding: 18px 6px;\n      border-radius: 12px;\n      border: 2px solid #c4a87c;\n      white-space: pre-wrap;\n      box-shadow: \n        inset 0 3px 8px rgba(0, 0, 0, 0.12),\n        inset 0 -1px 0 rgba(255, 255, 255, 0.6);\n      font-family: 'Georgia', 'Times New Roman', serif;\n      position: relative;\n      margin-left: 0;\n      width: calc(100% + 20px);\n      max-width: none;\n    }\n    \n    .diary-detail-content::before {\n      content: '';\n      position: absolute;\n      left: -35px;\n      top: 0;\n      bottom: 0;\n      width: 2px;\n      background: rgba(210, 180, 140, 0.3);\n      border-radius: 2px;\n    }\n    \n    .diary-back-btn {\n      background: \n        linear-gradient(135deg, #d2b48c 0%, #deb887 50%, #d2b48c 100%);\n      color: #f9f6f1;\n      border: 3px solid #bc9a6a;\n      padding: 15px 30px;\n      border-radius: 25px;\n      cursor: pointer;\n      font-size: 16px;\n      font-weight: 700;\n      margin-top: 30px;\n      transition: all 0.4s ease;\n      display: block;\n      margin-left: auto;\n      margin-right: auto;\n      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.4);\n      box-shadow: \n        0 6px 12px rgba(0, 0, 0, 0.25),\n        inset 0 2px 0 rgba(255, 255, 255, 0.3);\n      position: relative;\n      overflow: hidden;\n    }\n    \n    .diary-back-btn::before {\n      content: '';\n      position: absolute;\n      top: 0;\n      left: -100%;\n      width: 100%;\n      height: 100%;\n      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);\n      transition: left 0.5s ease;\n    }\n    \n    .diary-back-btn:hover {\n      background: \n        linear-gradient(135deg, #bc9a6a 0%, #d2b48c 50%, #bc9a6a 100%);\n      transform: translateY(-3px) scale(1.08);\n      box-shadow: \n        0 10px 20px rgba(0, 0, 0, 0.35),\n        inset 0 3px 0 rgba(255, 255, 255, 0.4),\n        0 0 25px rgba(255, 215, 0, 0.3);\n    }\n    \n    .diary-back-btn:hover::before {\n      left: 100%;\n    }\n    \n    /* 响应式设计 */\n    @media (max-width: 768px) {\n      .diary-popup-content {\n        width: 95%;\n        min-width: 340px;\n        max-width: 450px;\n        transform: perspective(800px) rotateX(1deg);\n      }\n      \n      .diary-popup-content:hover {\n        transform: perspective(800px) rotateX(0deg) scale(1.01);\n      }\n      \n      .diary-characters-grid,\n      .diary-entries-grid {\n        grid-template-columns: 1fr;\n        gap: 15px;\n      }\n      \n      .diary-content {\n        padding: 25px;\n      }\n      \n      .diary-cover {\n        margin: 20px;\n        padding: 50px 30px;\n      }\n      \n      .diary-cover-title {\n        font-size: 28px;\n      }\n      \n      .diary-cover-subtitle {\n        font-size: 16px;\n      }\n      \n      .diary-index-header {\n        flex-direction: column;\n        gap: 15px;\n        align-items: stretch;\n      }\n      \n      .diary-back-to-characters-btn {\n        align-self: flex-start;\n      }\n      \n      .diary-index-title {\n        margin: 0;\n        text-align: center;\n      }\n      \n      .diary-character-list,\n      .diary-index,\n      .diary-detail {\n        padding: 25px;\n        margin: 15px;\n      }\n      \n      .diary-entry-title {\n        font-size: 15px;\n        width: calc(100% - 25px);\n      }\n    }\n    `)\n  );\n  \n  // 创建弹窗HTML\n  const popupHtml = `\n    <div class=\"diary-popup-overlay\" id=\"diary-popup\">\n      <div class=\"diary-popup-content\">\n        <div class=\"diary-header\">\n          <h3 class=\"diary-title\">私人日记</h3>\n          <button class=\"diary-close-btn\" id=\"diary-close\">×</button>\n        </div>\n        <div class=\"diary-content\">\n          <div class=\"diary-cover\" id=\"diary-cover\">\n            <div class=\"diary-cover-inner\">\n              <div class=\"diary-cover-title\">我的日记本</div>\n              <div class=\"diary-cover-subtitle\">共收录${totalEntries}篇记录 · ${Object.keys(entriesByCharacter).length}位作者</div>\n              <button class=\"diary-cover-button\" id=\"diary-open-btn\">打开目录</button>\n            </div>\n          </div>\n          \n          <div class=\"diary-character-list\" id=\"diary-character-list\">\n            <div class=\"diary-character-list-title\">作者目录</div>\n            <div class=\"diary-characters-grid\" id=\"diary-characters-grid\">\n              <!-- 角色列表将动态插入这里 -->\n            </div>\n          </div>\n          \n          <div class=\"diary-index\" id=\"diary-index\">\n            <div class=\"diary-index-header\">\n              <button class=\"diary-back-to-characters-btn\" id=\"diary-back-to-characters\">返回作者目录</button>\n              <div class=\"diary-index-title\" id=\"diary-index-title-text\">日记目录</div>\n            </div>\n            <div class=\"diary-entries-grid\" id=\"diary-entries-grid\">\n              <!-- 日记条目将动态插入这里 -->\n            </div>\n            <div class=\"diary-pagination\" id=\"diary-pagination\">\n              <!-- 分页控件将动态插入这里 -->\n            </div>\n          </div>\n          \n          <div class=\"diary-detail\" id=\"diary-detail\">\n            <div class=\"diary-detail-title\" id=\"detail-title\"></div>\n            <div class=\"diary-detail-time\" id=\"detail-time\"></div>\n            <div class=\"diary-detail-content\" id=\"detail-content\"></div>\n            <button class=\"diary-back-btn\" id=\"diary-back\">返回目录</button>\n          </div>\n        </div>\n      </div>\n    </div>\n  `;\n  \n  // 添加弹窗到页面\n  $('body').append(popupHtml);\n  \n  // 初始化日记本逻辑\n  initializeDiaryBook(entriesByCharacter);\n}\n\n// 初始化日记本逻辑\nfunction initializeDiaryBook(entriesByCharacter) {\n  let currentPage = 0;\n  let currentCharacter = null;\n  let currentEntries = [];\n  \n  // 关闭弹窗\n  function closeDiary() {\n    $('#diary-popup').remove();\n    $('style[data-id=\"diary-styles\"]').remove();\n  }\n  \n  // 显示封面\n  function showCover() {\n    $('#diary-cover').show();\n    $('#diary-character-list').hide();\n    $('#diary-index').hide();\n    $('#diary-detail').hide();\n  }\n  \n  // 显示角色列表\n  function showCharacterList() {\n    $('#diary-cover').hide();\n    $('#diary-character-list').show();\n    $('#diary-index').hide();\n    $('#diary-detail').hide();\n    \n    renderCharacters();\n  }\n  \n  // 显示某角色的日记目录\n  function showCharacterDiaries(characterName, page = 0) {\n    currentCharacter = characterName;\n    currentEntries = entriesByCharacter[characterName] || [];\n    currentPage = page;\n    \n    $('#diary-cover').hide();\n    $('#diary-character-list').hide();\n    $('#diary-index').show();\n    $('#diary-detail').hide();\n    \n    $('#diary-index-title-text').text(`${characterName}的日记`);\n    \n    // 渲染当前页的日记条目\n    renderEntries(page);\n    renderPagination();\n  }\n  \n  // 显示详情\n  function showDetail(entry) {\n    $('#diary-cover').hide();\n    $('#diary-character-list').hide();\n    $('#diary-index').hide();\n    $('#diary-detail').show();\n    \n    $('#detail-title').text(entry.title);\n    $('#detail-time').text(entry.time);\n    $('#detail-content').text(entry.content);\n  }\n  \n  // 渲染角色列表\n  function renderCharacters() {\n    const grid = $('#diary-characters-grid');\n    grid.empty();\n    \n    Object.keys(entriesByCharacter).forEach(charName => {\n      const entries = entriesByCharacter[charName];\n      const characterHtml = `\n        <div class=\"diary-character-item\" data-char=\"${charName}\">\n          <div class=\"diary-character-name\">${charName}</div>\n          <div class=\"diary-character-count\">${entries.length}篇日记</div>\n        </div>\n      `;\n      grid.append(characterHtml);\n    });\n    \n    // 绑定角色点击事件\n    $('.diary-character-item').on('click', function() {\n      const charName = $(this).data('char');\n      showCharacterDiaries(charName, 0);\n    });\n  }\n  \n  // 渲染日记条目\n  function renderEntries(page) {\n    const totalPages = Math.ceil(currentEntries.length / PAGE_SIZE);\n    const startIndex = page * PAGE_SIZE;\n    const endIndex = Math.min(startIndex + PAGE_SIZE, currentEntries.length);\n    const pageEntries = currentEntries.slice(startIndex, endIndex);\n    \n    const grid = $('#diary-entries-grid');\n    grid.empty();\n    \n    pageEntries.forEach(entry => {\n      const entryHtml = `\n        <div class=\"diary-entry-item\" data-uid=\"${entry.uid}\">\n          <div class=\"diary-entry-title\">${entry.title}</div>\n          <div class=\"diary-entry-time\">${entry.time}</div>\n        </div>\n      `;\n      grid.append(entryHtml);\n    });\n    \n    // 绑定点击事件\n    $('.diary-entry-item').on('click', function() {\n      const uid = $(this).data('uid');\n      const entry = currentEntries.find(e => e.uid === uid);\n      if (entry) {\n        showDetail(entry);\n      }\n    });\n  }\n  \n  // 渲染分页控件\n  function renderPagination() {\n    const pagination = $('#diary-pagination');\n    pagination.empty();\n    \n    const totalPages = Math.ceil(currentEntries.length / PAGE_SIZE);\n    \n    if (totalPages <= 1) return;\n    \n    // 上一页按钮\n    const prevBtn = `<button class=\"diary-page-btn\" id=\"prev-page\" ${currentPage === 0 ? 'disabled' : ''}>◀ 上一页</button>`;\n    pagination.append(prevBtn);\n    \n    // 页码信息\n    const pageInfo = `<span class=\"diary-page-info\">${currentPage + 1} / ${totalPages}</span>`;\n    pagination.append(pageInfo);\n    \n    // 下一页按钮\n    const nextBtn = `<button class=\"diary-page-btn\" id=\"next-page\" ${currentPage === totalPages - 1 ? 'disabled' : ''}>下一页 ▶</button>`;\n    pagination.append(nextBtn);\n    \n    // 绑定分页事件\n    $('#prev-page').on('click', function() {\n      if (currentPage > 0) {\n        showCharacterDiaries(currentCharacter, currentPage - 1);\n      }\n    });\n    \n    $('#next-page').on('click', function() {\n      const totalPages = Math.ceil(currentEntries.length / PAGE_SIZE);\n      if (currentPage < totalPages - 1) {\n        showCharacterDiaries(currentCharacter, currentPage + 1);\n      }\n    });\n  }\n  \n  // 绑定事件\n  $('#diary-close').on('click', closeDiary);\n  $('#diary-popup').on('click', function(e) {\n    if (e.target.id === 'diary-popup') {\n      closeDiary();\n    }\n  });\n  $('.diary-popup-content').on('click', function(e) {\n    e.stopPropagation();\n  });\n  \n  $('#diary-cover-button, #diary-open-btn').on('click', function() {\n    showCharacterList();\n  });\n  \n  $('#diary-back').on('click', function() {\n    if (currentCharacter) {\n      showCharacterDiaries(currentCharacter, currentPage);\n    } else {\n      showCharacterList();\n    }\n  });\n  \n  $('#diary-back-to-characters').on('click', function() {\n    showCharacterList();\n  });\n  \n  // 初始显示封面\n  showCover();\n}\n\n// 监听按钮点击事件\neventOnButton('写日记', async () => {\n  await writeDiary();\n});\n\neventOnButton('日记本', async () => {\n  await showDiaryBook();\n});\n\n// 页面卸载时清理\n$(window).on('beforeunload', function() {\n  if (diaryMessageListener) {\n    clearInterval(diaryMessageListener);\n    diaryMessageListener = null;\n  }\n  $('#diary-popup').remove();\n  $('style[data-id=\"diary-styles\"]').remove();\n});\n\nconsole.log('日记本功能脚本已加载');",
  "info": "",
  "buttons": [
    {
      "name": "日记本",
      "visible": true
    },
    {
      "name": "写日记",
      "visible": true
    }
  ],
  "data": {}
}
